<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Cliente - TurnoSport</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root{
        --sidebar-bg:#222831;
        --sidebar-text:#eeeeee;
        --primary: #0d5e47;
        --surface:#ffffff;
        --muted:#7a7a7a;
        --danger:#e74c3c;
        --success:#27ae60;
        --warning:#f39c12;
        --card-shadow: 0 6px 18px rgba(34,40,49,0.08);
        --radius:12px;
        --font-sans: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
        margin:0;
        font-family:var(--font-sans);
        background:#f5f7fa;
        color:#222;
        display:flex;
        min-height:100vh;
    }

    /* SIDEBAR */
    .sidebar{
        width:260px;
        background:linear-gradient(180deg,#1f2933 0%,var(--sidebar-bg) 100%);
        color:var(--sidebar-text);
        padding:18px;
        display:flex;
        flex-direction:column;
        gap:12px;
        box-shadow: 4px 0 18px rgba(0,0,0,0.06);
    }
    .sidebar .brand{
        display:flex;
        align-items:center;
        justify-content:space-between;
    }
    .sidebar h2{margin:0;font-size:20px;letter-spacing:0.4px}
    .btn-toggle{background:transparent;border:none;color:var(--sidebar-text);font-size:18px;cursor:pointer}
    .menu ul{list-style:none;padding:0;margin:10px 0}
    .menu li{
        padding:12px 10px;
        border-radius:8px;
        margin-bottom:6px;
        cursor:pointer;
        display:flex;
        gap:10px;
        align-items:center;
        color:var(--sidebar-text);
    }
    .menu li:hover{background:rgba(255,255,255,0.03)}
    .menu li.active{background:rgba(255,255,255,0.06);box-shadow: inset 3px 0 0 var(--primary)}
    .menu li i{width:18px;text-align:center}

    /* Sidebar footer */
    .sidebar-footer{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .admin-info{line-height:1}
    .btn-logout{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--sidebar-text);padding:8px 10px;border-radius:8px;cursor:pointer}

    /* MAIN */
    .main{flex:1;display:flex;flex-direction:column;min-height:100vh}
    .topbar{
        display:flex;justify-content:space-between;align-items:center;
        padding:18px 28px;background:var(--primary);color:white;
        box-shadow: 0 4px 10px rgba(74,163,223,0.12);
    }
    .topbar h1{margin:0;font-size:18px;font-weight:600}
    .topbar .right{display:flex;gap:8px;align-items:center}
    .topbar input{padding:8px 12px;border-radius:8px;border:none;min-width:220px}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer}
    .btn.small{padding:6px 10px}
    .btn.primary{background:#fff;color:var(--primary);border:none;font-weight:600}
    .btn.primary i{margin-right:6px}
    .btn.success{background:var(--success);color:white;border:none}
    .btn.warning{background:var(--warning);color:white;border:none}
    .btn.danger{background:var(--danger);color:white;border:none}

    /* CONTENT */
    .content{padding:22px}
    .table-wrap{background:var(--surface);border-radius:12px;padding:18px;box-shadow:var(--card-shadow)}
    .table-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .table{width:100%;border-collapse:collapse}
    .table thead th{font-size:12px;color:var(--muted);text-align:left;padding:12px 8px;border-bottom:1px solid #eef2f6}
    .table tbody td{padding:12px 8px;border-bottom:1px solid #f1f4f8}
    .table tbody tr:hover{background:#fbfdff}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#f3f6fb;color:#2d6ca6;font-weight:600;font-size:12px}
    .actions button{border:none;background:transparent;cursor:pointer;margin-right:6px;font-size:14px}

    /* modal */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.5);z-index:60}
    .modal.hidden{display:none}
    .modal-content{width:520px;background:var(--surface);border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(2,6,23,0.25)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #eef2f6}
    .modal-body{padding:16px;max-height:60vh;overflow:auto}
    .modal-footer{padding:12px 18px;border-top:1px solid #eef2f6;display:flex;justify-content:flex-end;gap:10px}
    .modal input, .modal select, .modal textarea{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #e6e9ef}

    /* toast */
    .toast{position:fixed;right:24px;bottom:24px;padding:12px 14px;border-radius:10px;background:#111;color:#fff;box-shadow:0 6px 20px rgba(0,0,0,0.2)}
    .toast.hidden{display:none}

    /* pagination */
    .pagination{margin-top:12px;display:flex;gap:6px;align-items:center}
    .page-btn{padding:6px 10px;border-radius:8px;border:1px solid #e6e9ef;background:transparent;cursor:pointer}

    /* small helpers */
    .flex {display:flex;gap:8px;align-items:center}
    .muted {color:var(--muted);font-size:13px}
    .table-empty {padding:30px;text-align:center;color:var(--muted)}

    /* responsive */
    @media (max-width:900px){
        .sidebar{position:fixed;left:-280px;transition:left .22s;z-index:80}
        .sidebar.open{left:0}
        .main{margin-left:0}
    }

    /* Nuevos estilos para el flujo de reserva */
    .reserva-flow {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    .step {
      background: var(--surface);
      padding: 25px;
      border-radius: var(--radius);
      box-shadow: var(--card-shadow);
      border-left: 4px solid var(--primary);
    }

    .step-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .step-number {
      background: var(--primary);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .step-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }

    .step-content {
      margin-left: 44px;
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .option-card {
      background: white;
      border: 2px solid #e6e9ef;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .option-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .option-card.selected {
      border-color: var(--primary);
      background: #f0f9ff;
    }

    .option-icon {
      font-size: 32px;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .option-title {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .option-description {
      color: var(--muted);
      font-size: 14px;
    }

    .horarios-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .horario-btn {
      padding: 12px;
      border: 2px solid #e6e9ef;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      text-align: center;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .horario-btn:hover {
      background: #f8f9fa;
    }

    .horario-btn.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .horario-btn.ocupado {
      background: #f8d7da;
      color: #721c24;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .canchas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .cancha-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--card-shadow);
      border: 2px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .cancha-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .cancha-card.selected {
      border-color: var(--primary);
      background: #f0f9ff;
    }

    .cancha-card.disponible {
      border-left: 4px solid var(--success);
    }

    .cancha-card.ocupada {
      border-left: 4px solid var(--danger);
      opacity: 0.7;
      cursor: not-allowed;
    }

    .servicios-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .servicio-card {
      background: white;
      border: 2px solid #e6e9ef;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .servicio-card:hover {
      border-color: var(--primary);
    }

    .servicio-card.selected {
      border-color: var(--primary);
      background: #f0f9ff;
    }

    .resumen-reserva {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 8px;
      border-left: 4px solid var(--primary);
      margin: 20px 0;
    }

    .resumen-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e9ecef;
    }

    .resumen-total {
      font-weight: bold;
      font-size: 18px;
      color: var(--primary);
      border-bottom: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 2px solid #e9ecef;
    }

    .alerta-24h {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      color: #856404;
    }

    .hidden {
      display: none !important;
    }

    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <h2>TurnoSport</h2>
      <button id="btnToggle" class="btn-toggle"><i class="fa fa-bars"></i></button>
    </div>

    <nav class="menu">
      <ul>
        <li data-entity="mis-reservas" class="active"><i class="fa fa-calendar-check"></i> Mis Reservas</li>
        <li data-entity="nueva-reserva"><i class="fa fa-plus-circle"></i> Nueva Reserva</li>
        <li data-entity="canchas"><i class="fa fa-futbol"></i> Canchas</li>
        <li data-entity="servicios"><i class="fa fa-concierge-bell"></i> Servicios</li>
        <li data-entity="precios"><i class="fa fa-tag"></i> Precios</li>
      </ul>
    </nav>

    <div class="sidebar-footer">
      <div class="admin-info">
        <strong id="userName">Cliente</strong>
        <small class="muted" id="userEmail">cliente@email.com</small>
      </div>
      <button class="btn-logout" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
    </div>
  </aside>

  <main class="main">
    <header class="topbar">
      <div class="left">
        <h1 id="mainTitle">Mis Reservas</h1>
      </div>
      <div class="right">
        <div id="userWelcome">Bienvenido, <span id="userDisplayName">Cliente</span></div>
      </div>
    </header>

    <section class="content">
      <div id="contentArea">
        <!-- Contenido din√°mico se carga aqu√≠ -->
      </div>
    </section>
  </main>

  <!-- Modal para pago -->
  <div id="modalPago" class="modal hidden">
    <div class="modal-content" style="max-width: 500px;">
      <header class="modal-header">
        <h3>Procesar Pago</h3>
        <button class="close" onclick="closeModal('modalPago')"><i class="fa fa-times"></i></button>
      </header>
      <div class="modal-body">
        <div id="pagoInfo">
          <!-- Informaci√≥n del pago se carga aqu√≠ -->
        </div>
        <div class="price-calculation">
          <div class="price-total" id="pagoTotal">Total: $0</div>
        </div>
        
        <div style="margin-top: 20px;">
          <h4>Datos de Pago (Simulado)</h4>
          <input type="text" placeholder="N√∫mero de tarjeta" style="margin: 8px 0;" value="**** **** **** 1234" disabled>
          <input type="text" placeholder="Nombre en la tarjeta" style="margin: 8px 0;" value="TITULAR EJEMPLO" disabled>
          <div class="flex">
            <input type="text" placeholder="MM/AA" style="margin: 8px 4px 8px 0;" value="12/25" disabled>
            <input type="text" placeholder="CVV" style="margin: 8px 0 8px 4px;" value="123" disabled>
          </div>
        </div>
      </div>
      <footer class="modal-footer">
        <button class="btn" onclick="closeModal('modalPago')">Cancelar</button>
        <button class="btn success" id="btnProcesarPago" onclick="procesarPago()">
          <i class="fa fa-credit-card"></i> Procesar Pago
        </button>
      </footer>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <script>
    // CONFIGURACI√ìN INICIAL
    const API_BASE = 'http://localhost:3000';
    const API = {
      'localidades': API_BASE + '/api/localidades',
      'tipo-canchas': API_BASE + '/api/tipo-canchas',
      'canchas': API_BASE + '/api/canchas',
      'servicios': API_BASE + '/api/servicios',
      'precios': API_BASE + '/api/precios',
      'reservas': API_BASE + '/api/reservas',
      'disponibilidad': API_BASE + '/api/canchas/disponibilidad',
      'pagos': API_BASE + '/api/pagos'
    };

    // Estado de la aplicaci√≥n
    let currentUser = null;
    let currentSection = 'mis-reservas';
    let dataCache = {};
    let reservaActual = {
      localidad: null,
      deporte: null,
      fecha: null,
      horario: null,
      cancha: null,
      servicios: [],
      precio_total: 0
    };
    let reservaSeleccionadaPago = null;
    let pagoActual = null;
    let currentStep = 1;

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      init();
    });

    function init() {
      console.log('Inicializando aplicaci√≥n...');
      cargarUsuario();
      setupEventListeners();
      cargarSeccion('mis-reservas');
    }

    function cargarUsuario() {
      try {
        const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (userData) {
          currentUser = JSON.parse(userData);
          document.getElementById('userName').textContent = `${currentUser.nombre} ${currentUser.apellido || ''}`;
          document.getElementById('userEmail').textContent = currentUser.email || currentUser.username || '';
          document.getElementById('userDisplayName').textContent = `${currentUser.nombre} ${currentUser.apellido || ''}`;
        } else {
          console.log('No se encontr√≥ usuario en localStorage/sessionStorage');
        }
      } catch (e) {
        console.error('Error cargando usuario:', e);
      }
    }

    function setupEventListeners() {
      // Men√∫ lateral
      const menuItems = document.querySelectorAll('.menu li');
      menuItems.forEach(item => {
        item.addEventListener('click', (e) => {
          menuItems.forEach(i => i.classList.remove('active'));
          e.currentTarget.classList.add('active');
          currentSection = e.currentTarget.dataset.entity;
          document.getElementById('mainTitle').textContent = getTitleFromSection(currentSection);
          cargarSeccion(currentSection);
        });
      });

      // Bot√≥n toggle sidebar
      document.getElementById('btnToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('open');
      });
    }

    function getTitleFromSection(section) {
      const titles = {
        'mis-reservas': 'Mis Reservas',
        'nueva-reserva': 'Nueva Reserva',
        'canchas': 'Canchas Disponibles',
        'servicios': 'Servicios',
        'precios': 'Precios'
      };
      return titles[section] || section;
    }

    // CARGAR SECCIONES
    async function cargarSeccion(seccion) {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = '<div class="muted">Cargando...</div>';

      try {
        switch(seccion) {
          case 'mis-reservas':
            await cargarMisReservas();
            break;
          case 'nueva-reserva':
            await cargarNuevaReserva();
            break;
          case 'canchas':
            await cargarCanchas();
            break;
          case 'servicios':
            await cargarServicios();
            break;
          case 'precios':
            await cargarPrecios();
            break;
        }
      } catch (error) {
        console.error(`Error cargando secci√≥n ${seccion}:`, error);
        contentArea.innerHTML = `<div class="table-empty">Error al cargar: ${error.message}</div>`;
      }
    }

    // MIS RESERVAS - CORREGIDO (sin columna deporte)
    async function cargarMisReservas() {
      if (!currentUser) {
        document.getElementById('contentArea').innerHTML = '<div class="table-empty">Debe iniciar sesi√≥n</div>';
        return;
      }

      try {
        const response = await fetch(API['reservas']);
        const result = await response.json();

        if (!result.success) throw new Error(result.message);

        const todasReservas = result.data || [];
        const misReservas = todasReservas.filter(r => r.id_usuario === currentUser.id_usuario);

        // Obtener informaci√≥n de pagos para cada reserva
        const reservasConPagos = await Promise.all(
          misReservas.map(async (reserva) => {
            try {
              const pagoResponse = await fetch(`${API['pagos']}/reserva/${reserva.id_reserva}`);
              const pagoResult = await pagoResponse.json();
              
              return {
                ...reserva,
                estado_pago: pagoResult.success && pagoResult.data ? pagoResult.data.estado : 'pendiente'
              };
            } catch (error) {
              return {
                ...reserva,
                estado_pago: 'pendiente'
              };
            }
          })
        );

        let html = `
          <div class="table-controls">
            <div>
              <span class="badge">Mis Reservas</span>
              <small>${reservasConPagos.length} reservas encontradas</small>
            </div>
            <button class="btn primary" onclick="cargarSeccion('nueva-reserva')">
              <i class="fa fa-plus"></i> Nueva Reserva
            </button>
          </div>
        `;

        if (reservasConPagos.length === 0) {
          html += `
            <div class="table-empty">
              <p>No ten√©s reservas activas</p>
              <button class="btn primary" onclick="cargarSeccion('nueva-reserva')">Hacer mi primera reserva</button>
            </div>
          `;
        } else {
          html += `
            <table class="table">
              <thead>
                <tr>
                  <th>Cancha</th>
                  <th>Fecha</th>
                  <th>Horario</th>
                  <th>Duraci√≥n</th>
                  <th>Servicios</th>
                  <th>Total</th>
                  <th>Estado Pago</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                ${reservasConPagos.map(reserva => `
                  <tr>
                    <td>${escapeHtml(reserva.cancha_nombre || `Cancha ${reserva.id_cancha}`)}</td>
                    <td>${escapeHtml(formatearFecha(reserva.fecha))}</td>
                    <td>${escapeHtml(reserva.hora_inicio)} - ${escapeHtml(reserva.hora_fin)}</td>
                    <td>${calcularDuracion(reserva.hora_inicio, reserva.hora_fin)}</td>
                    <td>${reserva.servicios && reserva.servicios.length > 0 ? 
                      (Array.isArray(reserva.servicios) ? 
                        reserva.servicios.map(s => typeof s === 'object' ? s.nombre : s).join(', ') : 
                        reserva.servicios) : '-'}</td>
                    <td>$${escapeHtml(reserva.precio_total)}</td>
                    <td>
                      <span class="status-badge status-${reserva.estado_pago || 'pendiente'}">
                        ${reserva.estado_pago || 'pendiente'}
                      </span>
                    </td>
                    <td class="actions">
                      ${reserva.estado_pago !== 'completado' ? `
                        <button title="Pagar" onclick="mostrarPago(${reserva.id_reserva})" class="btn success small">
                          <i class="fa fa-credit-card"></i>
                        </button>
                        <button title="Modificar" onclick="modificarReserva(${reserva.id_reserva})" class="btn warning small">
                          <i class="fa fa-edit"></i>
                        </button>
                        <button title="Cancelar" onclick="cancelarReserva(${reserva.id_reserva})" class="btn danger small">
                          <i class="fa fa-times"></i>
                        </button>
                      ` : `
                        <button title="Ver detalles" onclick="verReserva(${reserva.id_reserva})" class="btn small">
                          <i class="fa fa-eye"></i>
                        </button>
                      `}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }

        document.getElementById('contentArea').innerHTML = html;
      } catch (error) {
        document.getElementById('contentArea').innerHTML = `<div class="table-empty">Error cargando reservas: ${error.message}</div>`;
      }
    }

    // NUEVA RESERVA - FLUJO PASO A PASO
    async function cargarNuevaReserva() {
      await Promise.all([
        fetchIfNeeded('localidades'),
        fetchIfNeeded('tipo-canchas'),
        fetchIfNeeded('servicios')
      ]);

      // Resetear estado de reserva
      reservaActual = {
        localidad: null,
        deporte: null,
        fecha: null,
        horario: null,
        cancha: null,
        servicios: [],
        precio_total: 0
      };
      currentStep = 1;

      mostrarPasoActual();
    }

    function mostrarPasoActual() {
      const contentArea = document.getElementById('contentArea');
      
      switch(currentStep) {
        case 1:
          mostrarPasoLocalidad();
          break;
        case 2:
          mostrarPasoDeporte();
          break;
        case 3:
          mostrarPasoFecha();
          break;
        case 4:
          mostrarPasoHorario();
          break;
        case 5:
          mostrarPasoCanchas();
          break;
        case 6:
          mostrarPasoServicios();
          break;
        case 7:
          mostrarResumenFinal();
          break;
      }
    }

    function mostrarPasoLocalidad() {
      const localidades = dataCache['localidades'] || [];
      
      const html = `
        <div class="reserva-flow">
          <div class="step">
            <div class="step-header">
              <div class="step-number">1</div>
              <h3 class="step-title">Seleccion√° la Localidad</h3>
            </div>
            <div class="step-content">
              <p class="muted">Eleg√≠ en qu√© localidad quer√©s jugar</p>
              <div class="options-grid">
                ${localidades.map(localidad => `
                  <div class="option-card ${reservaActual.localidad?.id_localidad === localidad.id_localidad ? 'selected' : ''}" 
                       onclick="seleccionarLocalidad(${JSON.stringify(localidad).replace(/"/g, '&quot;')})">
                    <div class="option-icon">
                      <i class="fa fa-map-marker-alt"></i>
                    </div>
                    <div class="option-title">${escapeHtml(localidad.nombre)}</div>
                  </div>
                `).join('')}
              </div>
              <div class="navigation-buttons">
                <button class="btn" onclick="cargarSeccion('mis-reservas')">Cancelar</button>
                <button class="btn primary" onclick="siguientePaso()" ${!reservaActual.localidad ? 'disabled' : ''}>
                  Siguiente <i class="fa fa-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('contentArea').innerHTML = html;
    }

    function mostrarPasoDeporte() {
      const tipos = dataCache['tipo-canchas'] || [];
      
      const html = `
        <div class="reserva-flow">
          <div class="step">
            <div class="step-header">
              <div class="step-number">2</div>
              <h3 class="step-title">Seleccion√° el Deporte</h3>
            </div>
            <div class="step-content">
              <p class="muted">Eleg√≠ qu√© deporte quer√©s practicar</p>
              <div class="options-grid">
                ${tipos.map(tipo => `
                  <div class="option-card ${reservaActual.deporte?.id_tipo === tipo.id_tipo ? 'selected' : ''}" 
                       onclick="seleccionarDeporte(${JSON.stringify(tipo).replace(/"/g, '&quot;')})">
                    <div class="option-icon">
                      <i class="fa fa-futbol"></i>
                    </div>
                    <div class="option-title">${escapeHtml(tipo.nombre)}</div>
                    <div class="option-description">${escapeHtml(tipo.deporte || 'Varios deportes')}</div>
                  </div>
                `).join('')}
              </div>
              <div class="navigation-buttons">
                <button class="btn" onclick="anteriorPaso()"><i class="fa fa-arrow-left"></i> Anterior</button>
                <button class="btn primary" onclick="siguientePaso()" ${!reservaActual.deporte ? 'disabled' : ''}>
                  Siguiente <i class="fa fa-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('contentArea').innerHTML = html;
    }

    function mostrarPasoFecha() {
      const hoy = new Date().toISOString().split('T')[0];
      const maxFecha = new Date();
      maxFecha.setDate(maxFecha.getDate() + 30);
      const maxFechaStr = maxFecha.toISOString().split('T')[0];

      const html = `
        <div class="reserva-flow">
          <div class="step">
            <div class="step-header">
              <div class="step-number">3</div>
              <h3 class="step-title">Seleccion√° la Fecha</h3>
            </div>
            <div class="step-content">
              <p class="muted">Eleg√≠ para qu√© d√≠a quer√©s reservar</p>
              <input type="date" id="fechaReserva" 
                     value="${reservaActual.fecha || hoy}" 
                     min="${hoy}" 
                     max="${maxFechaStr}"
                     style="padding: 12px; font-size: 16px; width: 100%; max-width: 300px;"
                     onchange="seleccionarFecha(this.value)">
              <div class="navigation-buttons">
                <button class="btn" onclick="anteriorPaso()"><i class="fa fa-arrow-left"></i> Anterior</button>
                <button class="btn primary" onclick="siguientePaso()" ${!reservaActual.fecha ? 'disabled' : ''}>
                  Siguiente <i class="fa fa-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('contentArea').innerHTML = html;
    }

    async function mostrarPasoHorario() {
      const html = `
        <div class="reserva-flow">
          <div class="step">
            <div class="step-header">
              <div class="step-number">4</div>
              <h3 class="step-title">Seleccion√° el Horario</h3>
            </div>
            <div class="step-content">
              <p class="muted">Buscando horarios disponibles...</p>
              <div id="horariosContainer"></div>
              <div class="navigation-buttons">
                <button class="btn" onclick="anteriorPaso()"><i class="fa fa-arrow-left"></i> Anterior</button>
                <button class="btn primary" onclick="siguientePaso()" ${!reservaActual.horario ? 'disabled' : ''}>
                  Siguiente <i class="fa fa-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('contentArea').innerHTML = html;
      await cargarHorariosDisponibles();
    }

  async function cargarHorariosDisponibles() {
  try {
    console.log('üîç Cargando horarios con:', {
      fecha: reservaActual.fecha,
      id_tipo: reservaActual.deporte.id_tipo,
      id_localidad: reservaActual.localidad.id_localidad
    });

    const params = new URLSearchParams({
      fecha: reservaActual.fecha
    });

    // Solo agregar par√°metros si tienen valores v√°lidos
    if (reservaActual.deporte && reservaActual.deporte.id_tipo) {
      params.append('id_tipo', reservaActual.deporte.id_tipo.toString());
    }
    
    if (reservaActual.localidad && reservaActual.localidad.id_localidad) {
      params.append('id_localidad', reservaActual.localidad.id_localidad.toString());
    }

    console.log('üìã Par√°metros enviados:', params.toString());

    const response = await fetch(`${API['disponibilidad']}?${params}`);
    
    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }
    
    const result = await response.json();
    console.log('üì¶ Respuesta del backend:', result);

    if (!result.success) {
      throw new Error(result.message || 'Error en la respuesta del servidor');
    }

    const canchas = result.data || [];
    const todosHorarios = new Set();

    // Recopilar todos los horarios disponibles
    canchas.forEach(cancha => {
      console.log(`üèüÔ∏è Cancha ${cancha.nombre}:`, cancha.horarios_disponibles);
      if (cancha.horarios_disponibles && Array.isArray(cancha.horarios_disponibles)) {
        cancha.horarios_disponibles.forEach(horario => {
          todosHorarios.add(horario);
        });
      }
    });

    const horariosArray = Array.from(todosHorarios).sort();
    console.log('üïê Horarios encontrados:', horariosArray);

    let horariosHTML = '';
    if (horariosArray.length > 0) {
      horariosHTML = `
        <p>Horarios disponibles para ${formatearFecha(reservaActual.fecha)}:</p>
        <div class="horarios-grid">
          ${horariosArray.map(horario => `
            <button class="horario-btn ${reservaActual.horario === horario ? 'selected' : ''}" 
                    onclick="seleccionarHorario('${horario}')">
              ${horario.substring(0, 5)}
            </button>
          `).join('')}
        </div>
      `;
    } else {
      horariosHTML = `
        <div class="table-empty">
          <p>No hay horarios disponibles para esta fecha</p>
          <p class="muted">Prob√° con otra fecha o configuraci√≥n</p>
        </div>
      `;
    }

    document.getElementById('horariosContainer').innerHTML = horariosHTML;
  } catch (error) {
    console.error('‚ùå Error cargando horarios:', error);
    document.getElementById('horariosContainer').innerHTML = `
      <div class="table-empty">
        <p>Error cargando horarios: ${error.message}</p>
        <p class="muted">Verifica la consola para m√°s detalles</p>
      </div>
    `;
  }
}
    async function mostrarPasoCanchas() {
      const html = `
        <div class="reserva-flow">
          <div class="step">
            <div class="step-header">
              <div class="step-number">5</div>
              <h3 class="step-title">Seleccion√° la Cancha</h3>
            </div>
            <div class="step-content">
              <p class="muted">Buscando canchas disponibles...</p>
              <div id="canchasContainer"></div>
              <div class="navigation-buttons">
                <button class="btn" onclick="anteriorPaso()"><i class="fa fa-arrow-left"></i> Anterior</button>
                <button class="btn primary" onclick="siguientePaso()" ${!reservaActual.cancha ? 'disabled' : ''}>
                  Siguiente <i class="fa fa-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('contentArea').innerHTML = html;
      await cargarCanchasDisponibles();
    }

    async function cargarCanchasDisponibles() {
      try {
        const params = new URLSearchParams({
          fecha: reservaActual.fecha,
          id_tipo: reservaActual.deporte.id_tipo,
          id_localidad: reservaActual.localidad.id_localidad
        });

        const response = await fetch(`${API['disponibilidad']}?${params}`);
        const result = await response.json();

        if (!result.success) throw new Error(result.message);

        const canchas = result.data || [];
        
        let canchasHTML = '';
        if (canchas.length > 0) {
          canchasHTML = `
            <p>Canchas disponibles para ${reservaActual.horario.substring(0, 5)}:</p>
            <div class="canchas-grid">
              ${canchas.map(cancha => {
                const estaDisponible = cancha.horarios_disponibles && 
                  cancha.horarios_disponibles.includes(reservaActual.horario);
                
                return `
                  <div class="cancha-card ${estaDisponible ? 'disponible' : 'ocupada'} ${reservaActual.cancha?.id_cancha === cancha.id_cancha ? 'selected' : ''}"
                       onclick="${estaDisponible ? `seleccionarCancha(${JSON.stringify(cancha).replace(/"/g, '&quot;')})` : ''}">
                    <h4>${escapeHtml(cancha.nombre)}</h4>
                    <p class="muted">${escapeHtml(cancha.localidad_nombre)} ‚Ä¢ ${escapeHtml(cancha.tipo_nombre)}</p>
                    <p><strong>Estado:</strong> ${estaDisponible ? 'Disponible' : 'Ocupada'}</p>
                    ${estaDisponible ? '' : '<p class="muted">No disponible en este horario</p>'}
                  </div>
                `;
              }).join('')}
            </div>
          `;
        } else {
          canchasHTML = '<div class="table-empty"><p>No hay canchas disponibles</p></div>';
        }

        document.getElementById('canchasContainer').innerHTML = canchasHTML;
      } catch (error) {
        document.getElementById('canchasContainer').innerHTML = `
          <div class="table-empty">
            <p>Error cargando canchas: ${error.message}</p>
          </div>
        `;
      }
    }

    function mostrarPasoServicios() {
      const servicios = dataCache['servicios'] || [];

      const html = `
        <div class="reserva-flow">
          <div class="step">
            <div class="step-header">
              <div class="step-number">6</div>
              <h3 class="step-title">Servicios Adicionales</h3>
            </div>
            <div class="step-content">
              <p class="muted">Seleccion√° servicios adicionales para tu reserva (opcional)</p>
              <div class="servicios-grid">
                ${servicios.map(servicio => {
                  const estaSeleccionado = reservaActual.servicios.some(s => s.id_servicio === servicio.id_servicio);
                  return `
                    <div class="servicio-card ${estaSeleccionado ? 'selected' : ''}" 
                         onclick="toggleServicio(${JSON.stringify(servicio).replace(/"/g, '&quot;')})">
                      <h4>${escapeHtml(servicio.nombre)}</h4>
                      <p class="price-total">$${servicio.precio_servicio || servicio.precio}</p>
                      <p class="muted">${servicio.descripcion || 'Servicio adicional'}</p>
                    </div>
                  `;
                }).join('')}
              </div>
              <div class="navigation-buttons">
                <button class="btn" onclick="anteriorPaso()"><i class="fa fa-arrow-left"></i> Anterior</button>
                <button class="btn primary" onclick="siguientePaso()">
                  Ver Resumen <i class="fa fa-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('contentArea').innerHTML = html;
    }

    async function mostrarResumenFinal() {
      // Calcular precio total
      await calcularPrecioFinal();

      const html = `
        <div class="reserva-flow">
          <div class="step">
            <div class="step-header">
              <div class="step-number">7</div>
              <h3 class="step-title">Confirm√° tu Reserva</h3>
            </div>
            <div class="step-content">
              <div class="resumen-reserva">
                <h4>Detalles de la Reserva</h4>
                <div class="resumen-item">
                  <span>Localidad:</span>
                  <span>${reservaActual.localidad.nombre}</span>
                </div>
                <div class="resumen-item">
                  <span>Deporte:</span>
                  <span>${reservaActual.deporte.nombre}</span>
                </div>
                <div class="resumen-item">
                  <span>Fecha:</span>
                  <span>${formatearFecha(reservaActual.fecha)}</span>
                </div>
                <div class="resumen-item">
                  <span>Horario:</span>
                  <span>${reservaActual.horario.substring(0, 5)}</span>
                </div>
                <div class="resumen-item">
                  <span>Cancha:</span>
                  <span>${reservaActual.cancha.nombre}</span>
                </div>
                <div class="resumen-item">
                  <span>Servicios:</span>
                  <span>${reservaActual.servicios.length > 0 ? 
                    reservaActual.servicios.map(s => s.nombre).join(', ') : 'Ninguno'}</span>
                </div>
                <div class="resumen-item resumen-total">
                  <span>Total:</span>
                  <span>$${reservaActual.precio_total}</span>
                </div>
              </div>

              <div class="alerta-24h">
                <i class="fa fa-exclamation-triangle"></i>
                <strong>Importante:</strong> Si pasadas las 24 horas la reserva no se abona, la reserva se dar√° como cancelada autom√°ticamente.
              </div>

              <div class="navigation-buttons">
                <button class="btn" onclick="anteriorPaso()"><i class="fa fa-arrow-left"></i> Anterior</button>
                <div style="display: flex; gap: 10px;">
                  <button class="btn warning" onclick="finalizarReserva(false)">
                    <i class="fa fa-clock"></i> Pagar Despu√©s
                  </button>
                  <button class="btn success" onclick="finalizarReserva(true)">
                    <i class="fa fa-credit-card"></i> Pagar Ahora
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('contentArea').innerHTML = html;
    }

    // FUNCIONES DE SELECCI√ìN
    function seleccionarLocalidad(localidad) {
      reservaActual.localidad = localidad;
      mostrarPasoActual();
    }

    function seleccionarDeporte(deporte) {
      reservaActual.deporte = deporte;
      mostrarPasoActual();
    }

    function seleccionarFecha(fecha) {
      reservaActual.fecha = fecha;
      mostrarPasoActual();
    }

    function seleccionarHorario(horario) {
      reservaActual.horario = horario;
      mostrarPasoActual();
    }

    function seleccionarCancha(cancha) {
      reservaActual.cancha = cancha;
      mostrarPasoActual();
    }

    function toggleServicio(servicio) {
      const index = reservaActual.servicios.findIndex(s => s.id_servicio === servicio.id_servicio);
      if (index > -1) {
        reservaActual.servicios.splice(index, 1);
      } else {
        reservaActual.servicios.push(servicio);
      }
      mostrarPasoActual();
    }

    // NAVEGACI√ìN
    function siguientePaso() {
      if (currentStep < 7) {
        currentStep++;
        mostrarPasoActual();
      }
    }

    function anteriorPaso() {
      if (currentStep > 1) {
        currentStep--;
        mostrarPasoActual();
      }
    }

    // ... (el resto de las funciones se mantienen igual, pero usar√© las siguientes)
    // Las funciones cargarCanchas, cargarServicios, cargarPrecios, procesarPago, etc. se mantienen igual

    // FUNCIONES AUXILIARES
    async function fetchIfNeeded(entity) {
      if (!dataCache[entity] || !Array.isArray(dataCache[entity]) || dataCache[entity].length === 0) {
        try {
          const response = await fetch(API[entity]);
          const result = await response.json();
          dataCache[entity] = Array.isArray(result) ? result : (result.data || []);
        } catch (error) {
          console.error(`Error cargando ${entity}:`, error);
          dataCache[entity] = [];
        }
      }
    }

    function calcularHoraFin(hora_inicio, horas = 1) {
      const [horasStr, minutosStr] = hora_inicio.split(':');
      let horasNum = parseInt(horasStr) + horas;
      return `${horasNum.toString().padStart(2, '0')}:${minutosStr}:00`;
    }

    function calcularDuracion(hora_inicio, hora_fin) {
      const inicio = new Date(`2000-01-01T${hora_inicio}`);
      const fin = new Date(`2000-01-01T${hora_fin}`);
      const diffMs = fin.getTime() - inicio.getTime();
      const diffHoras = diffMs / (1000 * 60 * 60);
      return `${diffHoras} hora${diffHoras !== 1 ? 's' : ''}`;
    }

    function formatearFecha(fecha) {
      try {
        let fechaObj;
        if (fecha.includes('T')) {
          fechaObj = new Date(fecha);
        } else {
          fechaObj = new Date(fecha + 'T00:00:00');
        }
        
        if (isNaN(fechaObj.getTime())) {
          return 'Fecha inv√°lida';
        }
        
        return fechaObj.toLocaleDateString('es-AR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      } catch (e) {
        return 'Fecha inv√°lida';
      }
    }

    function escapeHtml(str) {
      if (str === undefined || str === null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    function showToast(msg, time = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), time);
    }

    function cerrarSesion() {
      if (confirm('¬øEst√°s seguro de que quer√©s cerrar sesi√≥n?')) {
        localStorage.removeItem('userData');
        sessionStorage.removeItem('userData');
        window.location.href = 'index.html';
      }
    }

    // Funciones placeholder para acciones futuras
    function modificarReserva(id) {
      showToast('Funcionalidad de modificaci√≥n en desarrollo');
    }

    function cancelarReserva(id) {
      if (confirm('¬øEst√°s seguro de que quer√©s cancelar esta reserva?')) {
        showToast('Funcionalidad de cancelaci√≥n en desarrollo');
      }
    }

    function verReserva(id) {
      showToast('Funcionalidad de visualizaci√≥n en desarrollo');
    }

    // C√°lculo de precio final
    async function calcularPrecioFinal() {
      try {
        const hora_fin = calcularHoraFin(reservaActual.horario, 1);
        const id_servicios = reservaActual.servicios.map(s => s.id_servicio);

        const response = await fetch(API['reservas'] + '/calcular-precio', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            id_cancha: reservaActual.cancha.id_cancha,
            fecha: reservaActual.fecha,
            hora_inicio: reservaActual.horario,
            hora_fin: hora_fin,
            id_servicios: id_servicios
          })
        });

        const result = await response.json();
        
        if (result.success) {
          reservaActual.precio_total = result.data.precio_total;
        }
      } catch (error) {
        console.error('Error calculando precio:', error);
        // Precio por defecto si falla el c√°lculo
        reservaActual.precio_total = 5000;
      }
    }

    // Finalizar reserva
    async function finalizarReserva(pagarAhora = false) {
      if (!currentUser) {
        showToast('Debe iniciar sesi√≥n para hacer una reserva');
        return;
      }

      try {
        const hora_fin = calcularHoraFin(reservaActual.horario, 1);
        const id_servicios = reservaActual.servicios.map(s => s.id_servicio);

        const reservaData = {
          id_usuario: currentUser.id_usuario,
          id_cancha: reservaActual.cancha.id_cancha,
          fecha: reservaActual.fecha,
          hora_inicio: reservaActual.horario,
          hora_fin: hora_fin,
          precio_total: reservaActual.precio_total,
          id_servicios: id_servicios
        };

        const response = await fetch(API['reservas'], {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(reservaData)
        });

        const result = await response.json();

        if (result.success) {
          // Crear pago autom√°ticamente
          await crearPago(result.data.id_reserva, reservaActual.precio_total);
          
          if (pagarAhora) {
            // Mostrar modal de pago inmediatamente
            mostrarPago(result.data.id_reserva);
          } else {
            showToast('Reserva creada exitosamente. Tienes 24 horas para realizar el pago.');
            cargarSeccion('mis-reservas');
          }
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        showToast('Error creando reserva: ' + error.message);
      }
    }

    async function crearPago(id_reserva, monto) {
      try {
        const response = await fetch(API['pagos'], {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            id_reserva: id_reserva,
            monto: monto,
            metodo_pago: 'tarjeta'
          })
        });

        const result = await response.json();
        if (result.success) {
          pagoActual = result.data;
          return result.data;
        }
      } catch (error) {
        console.error('Error creando pago:', error);
      }
    }

    // Las funciones de otras secciones (canchas, servicios, precios) se mantienen igual
    async function cargarCanchas() {
      await fetchIfNeeded('canchas');
      const canchas = dataCache['canchas'] || [];

      const html = `
        <div class="table-controls">
          <div>
            <span class="badge">Canchas</span>
            <small>${canchas.length} canchas disponibles</small>
          </div>
        </div>
        <div class="canchas-grid">
          ${canchas.map(cancha => `
            <div class="cancha-card ${cancha.estado === 'disponible' ? 'disponible' : 'ocupada'}">
              <h4>${escapeHtml(cancha.nombre)}</h4>
              <p class="muted">${cancha.localidad_nombre || 'Sin localidad'} ‚Ä¢ ${cancha.tipo_nombre || 'Sin tipo'}</p>
              <p>Estado: <span class="status-badge status-${cancha.estado || 'desconocido'}">${cancha.estado || 'desconocido'}</span></p>
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('contentArea').innerHTML = html;
    }

    async function cargarServicios() {
      await fetchIfNeeded('servicios');
      const servicios = dataCache['servicios'] || [];

      const html = `
        <div class="table-controls">
          <div>
            <span class="badge">Servicios</span>
            <small>${servicios.length} servicios disponibles</small>
          </div>
        </div>
        <div class="canchas-grid">
          ${servicios.map(servicio => `
            <div class="cancha-card">
              <h4>${escapeHtml(servicio.nombre)}</h4>
              <p class="price-total">$${servicio.precio_servicio || servicio.precio}</p>
              <p class="muted">Servicio adicional para tu reserva</p>
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('contentArea').innerHTML = html;
    }

    async function cargarPrecios() {
      await fetchIfNeeded('precios');
      await fetchIfNeeded('canchas');
      
      const precios = dataCache['precios'] || [];
      const canchasMap = new Map((dataCache['canchas'] || []).map(c => [c.id_cancha, c]));

      const html = `
        <div class="table-controls">
          <div>
            <span class="badge">Precios</span>
            <small>${precios.length} precios configurados</small>
          </div>
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>Cancha</th>
              <th>Valor por Hora</th>
              <th>Fecha de Vigencia</th>
            </tr>
          </thead>
          <tbody>
            ${precios.map(precio => {
              const cancha = canchasMap.get(precio.id_cancha);
              return `
                <tr>
                  <td>${cancha ? escapeHtml(cancha.nombre) : `Cancha ${precio.id_cancha}`}</td>
                  <td>$${escapeHtml(precio.valor_por_hora)}</td>
                  <td>${precio.fecha_vigencia ? formatearFecha(precio.fecha_vigencia) : 'Vigente'}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      document.getElementById('contentArea').innerHTML = html;
    }

  </script>
</body>
</html>